<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scanner Stok Barang</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f8f8f8; }
    label, input, button { margin: 5px 0; display: block; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    .lokasi-buttons { display: flex; gap: 10px; margin-bottom: 10px; }
    #reader { width: 100%; max-width: 400px; margin: 10px 0; display: none; }
    .button-group { display: flex; gap: 10px; margin-top: 10px; }
    .button-group button { flex: 1; }
    #uploadedItemsTable { margin-top: 20px; }
    .tab-container { display: flex; margin-bottom: 10px; }
    .tab { padding: 10px 15px; cursor: pointer; background: #ddd; border-radius: 5px 5px 0 0; }
    .tab.active { background: #fff; border-bottom: 2px solid #4CAF50; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    th:nth-child(1), td:nth-child(1) { width: 15%; }
    th:nth-child(2), td:nth-child(2) { width: 55%; }
    th:nth-child(3), td:nth-child(3) { width: 10%; }
    th:nth-child(4), td:nth-child(4) { width: 10%; }
    
    td:nth-child(3) input {
      width: 60px;
      text-align: center;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 5px;
      text-align: center;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .user-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .user-button {
      padding: 8px 12px;
      background: #e0e0e0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .user-button.active {
      background: #4CAF50;
      color: white;
    }
    
    .camera-status {
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
    }
    .camera-status.active {
      background: #d4edda;
      color: #155724;
    }
    .camera-status.inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
    }
    .progress-bar {
      width: 0%;
      height: 20px;
      background-color: #4CAF50;
      border-radius: 5px;
      text-align: center;
      color: white;
      line-height: 20px;
      transition: width 0.3s ease;
    }
    
    .download-status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      display: none;
    }
    .download-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .download-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button:active {
      transform: scale(0.98);
    }
    button:hover:not(:disabled) {
      opacity: 0.9;
    }
    button {
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/achmadnawawi44-sudo/Scanner-barang-SO/main/goto.png" alt="Logo Perusahaan" style="width:150px; margin-bottom:10px;">
  <h2>Scanner Stok Opname Goto Living</h2>

  <!-- Modal Konfirmasi -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3>Konfirmasi</h3>
      <p>Apakah Anda yakin ingin meninggalkan halaman ini? Semua data yang belum disimpan akan hilang.</p>
      <div class="modal-buttons">
        <button id="confirmLeaveYes" style="background-color: #f44336; color: white;">Ya, Keluar</button>
        <button id="confirmLeaveNo" style="background-color: #4CAF50; color: white;">Tidak, Tetap</button>
      </div>
    </div>
  </div>

  <!-- Modal Supabase Settings -->
  <div id="supabaseModal" class="modal">
    <div class="modal-content">
      <h3>Konfigurasi Supabase</h3>
      <p>Masukkan kredensial Supabase Anda:</p>
      <label>URL Supabase:</label>
      <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" />
      <label>API Key:</label>
      <input type="password" id="supabaseKey" placeholder="Your API Key" />
      <div class="modal-buttons">
        <button id="saveSupabaseConfigBtn" style="background-color: #4CAF50; color: white;">Simpan</button>
        <button id="cancelSupabaseConfigBtn" style="background-color: #f44336; color: white;">Batal</button>
      </div>
    </div>
  </div>

  <!-- Modal Download Supabase -->
  <div id="downloadModal" class="modal">
    <div class="modal-content">
      <h3>Download Data dari Supabase</h3>
      <label>Tanggal Mulai:</label>
      <input type="date" id="startDate" />
      <label>Tanggal Selesai:</label>
      <input type="date" id="endDate" />
      <label>User:</label>
      <div id="userList" class="user-list">
        <button class="user-button active" data-user="all">Semua User</button>
      </div>
      
      <div id="progressContainer" class="progress-container">
        <div id="progressBar" class="progress-bar">0%</div>
      </div>
      
      <div id="downloadStatus" class="download-status"></div>
      
      <div class="modal-buttons">
        <button id="downloadSupabaseBtn" style="background-color: #4CAF50; color: white;">Download</button>
        <button id="cancelDownloadBtn" style="background-color: #f44336; color: white;">Batal</button>
      </div>
    </div>
  </div>

  <!-- Tab Container -->
  <div class="tab-container">
    <div class="tab active" data-tab="scanTab">Mode Scan</div>
    <div class="tab" data-tab="uploadTab">Mode Upload Data</div>
  </div>

  <!-- Scan Tab -->
  <div id="scanTab" class="tab-content active">
    <label>User:</label>
    <input type="text" id="userInput" placeholder="Nama user" value="User 1" />
    
    <label>Nama Lokasi:</label>
    <input type="text" id="lokasiInput" placeholder="Contoh: Area A" />
    <div class="lokasi-buttons">
      <button id="lockLokasiBtn">üîíKunci Lokasi</button>
      <button id="ubahLokasiBtn">üîìUbah Lokasi</button>
    </div>

    <hr>

    <label>üì§Upload File Data Barang (CSV/XLSX):</label>
    <input type="file" id="uploadFile" accept=".csv, .xlsx" />
    <button id="uploadFileBtn">Upload</button>

    <hr>

    <label>Scan Barcode:</label>
    <input type="text" id="barcodeInput" placeholder="Scan barcode..." autofocus />
    <button id="scannerButton">üì∑ Aktifkan Kamera</button>
    <div id="cameraStatus" class="camera-status inactive">Kamera tidak aktif</div>
    <div id="reader"></div>

    <label>Nama Barang:</label>
    <input type="text" id="namaBarangInput" disabled />
    <label>Qty:</label>
    <input type="number" id="qtyInput" placeholder="Jumlah..." />
    <button id="tambahDataBtn">Tambah</button>

    <hr>

    <h3>Data Stok Barang:</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th>User</th>
          <th>Lokasi</th>
          <th>Barcode</th>
          <th>Nama Barang</th>
          <th>Qty</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Upload Data Tab -->
  <div id="uploadTab" class="tab-content">
    <label>User:</label>
    <input type="text" id="uploadUserInput" placeholder="Nama user" value="User 1" />
    
    <label>Nama Lokasi:</label>
    <input type="text" id="uploadLokasiInput" placeholder="Contoh: Area A" />
    <div class="lokasi-buttons">
      <button id="lockUploadLokasiBtn">üîíKunci Lokasi</button>
      <button id="ubahUploadLokasiBtn">üîìUbah Lokasi</button>
    </div>

    <hr>

    <label>üì§Upload File Data Barang (CSV/XLSX):</label>
    <input type="file" id="bulkUploadFile" accept=".csv, .xlsx" />
    <button id="bulkUploadBtn">Upload Data</button>

    <hr>

    <h3>Data yang Diupload:</h3>
    <table id="uploadedItemsTable">
      <thead>
        <tr>
          <th>Barcode</th>
          <th>Nama Barang</th>
          <th>Qty</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="uploadedItemsBody"></tbody>
    </table>

    <div class="button-group" style="margin-top: 20px;">
      <button id="saveUploadedDataBtn" style="background-color: #4CAF50; color: white;">Simpan Data</button>
      <button id="clearUploadedDataBtn" style="background-color: #f44336; color: white;">Hapus Data</button>
    </div>
  </div>

  <!-- Main Buttons -->
  <div class="button-group">
    <button id="exportDataBtn">Download Data (Excel)</button>
    <button id="saveToSupabaseBtn" style="background-color: #3b82f6; color: white;">Simpan ke Supabase</button>
    <button id="showDownloadModalBtn" style="background-color: #8b5cf6; color: white;">Download dari Supabase</button>
    <button id="showSupabaseConfigBtn" style="background-color: #6b7280; color: white;">Supabase Settings</button>
    <button id="hapusSemuaDataBtn" style="background-color: red; color: white;">Hapus Semua Data</button>
  </div>

  <!-- Debug Panel -->
  <div style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px;">
    <button id="debugBtn" style="background-color: #ff9800; color: white;">Debug Functions</button>
    <button id="clearAllDataBtn" style="background-color: #9c27b0; color: white;">Clear All Data</button>
    <div id="debugInfo" style="margin-top: 10px; font-size: 11px; color: #666;"></div>
  </div>

  <script>
    // =============== VARIABEL GLOBAL ===============
    let dataBarang = {};
    let dataScan = [];
    let lokasiTerkunci = false;
    let uploadLokasiTerkunci = false;
    let scanner = null;
    let uploadedItems = [];
    let shouldConfirmLeave = false;
    let supabaseClient = null; // Ganti nama variabel untuk hindari konflik
    let cameraActive = false;
    let isDownloading = false;

    // =============== FUNGSI INISIALISASI ===============
    function initApp() {
      console.log('Initializing app...');
      
      // Load data dari localStorage
      loadDataFromLocalStorage();
      
      // Setup event listeners
      setupEventListeners();
      
      // Fokus ke input barcode
      setTimeout(() => {
        const barcodeInput = document.getElementById("barcodeInput");
        if (barcodeInput) barcodeInput.focus();
      }, 500);
      
      console.log('App initialized successfully');
    }

    function loadDataFromLocalStorage() {
      console.log('Loading data from localStorage...');
      try {
        const savedDataScan = localStorage.getItem("dataScan");
        const savedUploadedItems = localStorage.getItem("uploadedItems");
        
        if (savedDataScan) {
          dataScan = JSON.parse(savedDataScan);
        }
        
        if (savedUploadedItems) {
          uploadedItems = JSON.parse(savedUploadedItems);
        }
      } catch (error) {
        console.error("Error loading from localStorage:", error);
        dataScan = [];
        uploadedItems = [];
      }
      
      updateTable();
      updateUploadedItemsTable();
      
      shouldConfirmLeave = (dataScan.length > 0 || uploadedItems.length > 0);
      
      // Cek konfigurasi Supabase
      const supabaseUrl = localStorage.getItem("supabaseUrl");
      const supabaseKey = localStorage.getItem("supabaseKey");
      
      if (supabaseUrl && supabaseKey) {
        initSupabaseClient(supabaseUrl, supabaseKey);
      }
    }

    function saveDataToLocalStorage() {
      try {
        localStorage.setItem("dataScan", JSON.stringify(dataScan || []));
        localStorage.setItem("uploadedItems", JSON.stringify(uploadedItems || []));
        shouldConfirmLeave = ((dataScan && dataScan.length > 0) || (uploadedItems && uploadedItems.length > 0));
      } catch (error) {
        console.error("Error saving to localStorage:", error);
      }
    }

    // =============== FUNGSI TAB ===============
    function openTab(tabId, clickedTab) {
      console.log('Opening tab:', tabId);
      
      // Sembunyikan semua tab content
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Tampilkan tab yang dipilih
      const selectedTab = document.getElementById(tabId);
      if (selectedTab) {
        selectedTab.classList.add('active');
      }
      
      // Update tab menu
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Aktifkan tab yang diklik
      if (clickedTab) {
        clickedTab.classList.add('active');
      }
      
      // Jika berpindah tab, matikan kamera
      if (cameraActive) {
        toggleScanner();
      }
      
      // Fokus ke input yang sesuai
      if (tabId === 'scanTab') {
        setTimeout(() => {
          const barcodeInput = document.getElementById('barcodeInput');
          if (barcodeInput) barcodeInput.focus();
        }, 100);
      }
    }

    // =============== FUNGSI LOKASI ===============
    function lockLokasi() {
      console.log('Lock lokasi clicked');
      const lokasi = document.getElementById("lokasiInput");
      if (!lokasi) {
        alert("Input lokasi tidak ditemukan!");
        return;
      }
      
      if (lokasi.value.trim() === "") {
        alert("Masukkan nama lokasi terlebih dahulu.");
        return;
      }
      lokasi.disabled = true;
      lokasiTerkunci = true;
      alert("Lokasi '" + lokasi.value + "' dikunci. Silakan mulai scan.");
    }

    function ubahLokasi() {
      console.log('Ubah lokasi clicked');
      const lokasi = document.getElementById("lokasiInput");
      if (!lokasi) return;
      
      lokasi.disabled = false;
      lokasiTerkunci = false;
      lokasi.focus();
    }

    function lockUploadLokasi() {
      console.log('Lock upload lokasi clicked');
      const lokasi = document.getElementById("uploadLokasiInput");
      if (!lokasi) {
        alert("Input lokasi upload tidak ditemukan!");
        return;
      }
      
      if (lokasi.value.trim() === "") {
        alert("Masukkan nama lokasi terlebih dahulu.");
        return;
      }
      lokasi.disabled = true;
      uploadLokasiTerkunci = true;
      alert("Lokasi '" + lokasi.value + "' dikunci. Silakan upload data.");
    }

    function ubahUploadLokasi() {
      console.log('Ubah upload lokasi clicked');
      const lokasi = document.getElementById("uploadLokasiInput");
      if (!lokasi) return;
      
      lokasi.disabled = false;
      uploadLokasiTerkunci = false;
      lokasi.focus();
    }

    // =============== FUNGSI UPLOAD FILE ===============
    function handleFileUpload() {
      console.log('Handle file upload clicked');
      const fileInput = document.getElementById("uploadFile");
      if (!fileInput) {
        alert("File input tidak ditemukan!");
        return;
      }
      
      const file = fileInput.files[0];
      if (!file) {
        alert("Pilih file terlebih dahulu.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet);

          let count = 0;
          json.forEach(item => {
            const keys = Object.keys(item);
            const barcodeKey = keys.find(k => k.toLowerCase().includes("barcode") || k.toLowerCase().includes("kode"));
            const namaKey = keys.find(k => k.toLowerCase().includes("nama") || k.toLowerCase().includes("item"));

            if (barcodeKey && namaKey) {
              const barcode = item[barcodeKey]?.toString().trim();
              const nama = item[namaKey]?.toString().trim();
              if (barcode && nama) {
                dataBarang[barcode] = nama;
                count++;
              }
            }
          });

          alert(`‚úÖ Berhasil upload ${count} data barang.`);
        } catch (error) {
          alert("‚ùå Gagal membaca file: " + error.message);
          console.error("Error reading file:", error);
        }
      };
      reader.onerror = function(error) {
        alert("‚ùå Gagal membaca file.");
        console.error("FileReader error:", error);
      };
      reader.readAsArrayBuffer(file);
    }

    function handleBulkUpload() {
      console.log('Handle bulk upload clicked');
      if (!uploadLokasiTerkunci) {
        alert("Kunci lokasi terlebih dahulu.");
        return;
      }

      const fileInput = document.getElementById("bulkUploadFile");
      if (!fileInput) {
        alert("File input tidak ditemukan!");
        return;
      }
      
      const file = fileInput.files[0];
      if (!file) {
        alert("Pilih file terlebih dahulu.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet);

          uploadedItems = [];
          let count = 0;
          
          json.forEach(item => {
            const keys = Object.keys(item);
            const barcodeKey = keys.find(k => k.toLowerCase().includes("barcode") || k.toLowerCase().includes("kode"));
            const namaKey = keys.find(k => k.toLowerCase().includes("nama") || k.toLowerCase().includes("item"));
            const qtyKey = keys.find(k => k.toLowerCase().includes("qty") || k.toLowerCase().includes("quantity") || k.toLowerCase().includes("jumlah"));

            if (barcodeKey && namaKey) {
              const barcode = item[barcodeKey]?.toString().trim();
              const nama = item[namaKey]?.toString().trim();
              let qty = 0;
              
              if (qtyKey) {
                qty = parseInt(item[qtyKey]) || 0;
              }

              if (barcode && nama) {
                uploadedItems.push({
                  barcode: barcode,
                  nama: nama,
                  qty: qty
                });
                count++;
              }
            }
          });

          updateUploadedItemsTable();
          saveDataToLocalStorage();
          alert(`‚úÖ Berhasil upload ${count} data barang.`);
        } catch (error) {
          alert("‚ùå Gagal membaca file: " + error.message);
          console.error("Error reading file:", error);
        }
      };
      reader.onerror = function(error) {
        alert("‚ùå Gagal membaca file.");
        console.error("FileReader error:", error);
      };
      reader.readAsArrayBuffer(file);
    }

    // =============== FUNGSI TABEL ===============
    function updateUploadedItemsTable() {
      const tbody = document.getElementById("uploadedItemsBody");
      if (!tbody) return;
      
      tbody.innerHTML = "";

      uploadedItems.forEach((item, index) => {
        const row = tbody.insertRow();
        row.insertCell().innerText = item.barcode;
        row.insertCell().innerText = item.nama;
        
        const qtyCell = row.insertCell();
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.value = item.qty;
        qtyInput.style.width = "60px";
        qtyInput.onchange = (e) => {
          uploadedItems[index].qty = parseInt(e.target.value) || 0;
          saveDataToLocalStorage();
        };
        qtyCell.appendChild(qtyInput);

        const actionCell = row.insertCell();
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Hapus";
        deleteBtn.onclick = () => {
          if (confirm("Yakin ingin menghapus item ini?")) {
            uploadedItems.splice(index, 1);
            updateUploadedItemsTable();
            saveDataToLocalStorage();
          }
        };
        actionCell.appendChild(deleteBtn);
      });
    }

    function updateTable() {
      const tbody = document.querySelector("#dataTable tbody");
      if (!tbody) return;
      
      tbody.innerHTML = "";

      dataScan.forEach((item, index) => {
        const row = tbody.insertRow();
        row.insertCell().innerText = item.user || "Unknown";
        row.insertCell().innerText = item.lokasi;
        row.insertCell().innerText = item.barcode;
        row.insertCell().innerText = item.nama;
        row.insertCell().innerText = item.qty;

        const aksiCell = row.insertCell();
        
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.style.marginRight = "5px";
        editBtn.onclick = () => {
          const newQty = prompt("Masukkan Qty baru:", item.qty);
          if (newQty !== null && !isNaN(newQty)) {
            item.qty = parseInt(newQty);
            saveDataToLocalStorage();
            updateTable();
          }
        };
        aksiCell.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "Hapus";
        delBtn.style.backgroundColor = "#f44336";
        delBtn.style.color = "white";
        delBtn.onclick = () => {
          if (confirm("Yakin ingin menghapus baris ini?")) {
            dataScan.splice(index, 1);
            saveDataToLocalStorage();
            updateTable();
          }
        };
        aksiCell.appendChild(delBtn);
      });
    }

    // =============== FUNGSI TAMBAH DATA ===============
    function tambahData() {
      console.log('Tambah data clicked');
      if (!lokasiTerkunci) {
        alert("Kunci lokasi terlebih dahulu.");
        return;
      }

      const user = document.getElementById("userInput").value || "Unknown";
      const lokasi = document.getElementById("lokasiInput").value;
      const barcode = document.getElementById("barcodeInput").value.trim();
      const nama = document.getElementById("namaBarangInput").value;
      const qty = parseInt(document.getElementById("qtyInput").value);

      if (!barcode) {
        alert("Barcode tidak boleh kosong.");
        return;
      }
      
      if (isNaN(qty) || qty <= 0) {
        alert("Qty harus berupa angka yang valid.");
        return;
      }

      const index = dataScan.findIndex(item => item.barcode === barcode && item.lokasi === lokasi && item.user === user);
      if (index > -1) {
        dataScan[index].qty += qty;
      } else {
        dataScan.push({ 
          user: user,
          lokasi: lokasi, 
          barcode: barcode, 
          nama: nama || "Barang tidak dikenal", 
          qty: qty 
        });
      }

      saveDataToLocalStorage();
      document.getElementById("barcodeInput").value = "";
      document.getElementById("namaBarangInput").value = "";
      document.getElementById("qtyInput").value = "";
      document.getElementById("barcodeInput").focus();
      updateTable();
    }

    // =============== FUNGSI SCANNER ===============
    async function toggleScanner() {
      console.log('Toggle scanner clicked');
      
      if (typeof Html5Qrcode === 'undefined') {
        alert('Library scanner tidak tersedia. Periksa koneksi internet.');
        return;
      }
      
      const readerDiv = document.getElementById("reader");
      const scannerButton = document.getElementById("scannerButton");
      const cameraStatus = document.getElementById("cameraStatus");
      
      // Hentikan scanner jika aktif
      if (scanner && cameraActive) {
        try {
          await scanner.stop();
          cameraActive = false;
          readerDiv.style.display = "none";
          readerDiv.innerHTML = "";
          scannerButton.textContent = "üì∑ Aktifkan Kamera";
          cameraStatus.textContent = "Kamera tidak aktif";
          cameraStatus.className = "camera-status inactive";
          return;
        } catch (error) {
          console.error("Error stopping scanner:", error);
        }
      }
      
      // Mulai scanner
      readerDiv.style.display = "block";
      readerDiv.innerHTML = "<div>Menginisialisasi kamera...</div>";

      try {
        scanner = new Html5Qrcode("reader");
        
        await scanner.start(
          { facingMode: "environment" },
          { 
            fps: 10, 
            qrbox: { width: 250, height: 150 },
            aspectRatio: 1.0
          },
          (decodedText) => {
            console.log("Scanned:", decodedText);
            document.getElementById("barcodeInput").value = decodedText;
            
            const nama = dataBarang[decodedText];
            document.getElementById("namaBarangInput").value = nama || "Barang tidak ditemukan";
            
            document.getElementById("qtyInput").focus();
            
            scanner.stop().then(() => {
              cameraActive = false;
              readerDiv.innerHTML = "";
              readerDiv.style.display = "none";
              scannerButton.textContent = "üì∑ Aktifkan Kamera";
              cameraStatus.textContent = "Kamera tidak aktif";
              cameraStatus.className = "camera-status inactive";
            }).catch(err => {
              console.error("Error stopping scanner:", err);
            });
          },
          (errorMsg) => {
            if (errorMsg && !errorMsg.includes("NotFoundException")) {
              console.log("Scanning...", errorMsg);
            }
          }
        );
        
        cameraActive = true;
        scannerButton.textContent = "üõë Matikan Kamera";
        cameraStatus.textContent = "Kamera aktif - Arahkan ke barcode";
        cameraStatus.className = "camera-status active";
        
      } catch (err) {
        console.error("Error starting scanner:", err);
        
        let errorMessage = "Gagal membuka kamera: ";
        if (err.toString().includes("NotAllowedError")) {
          errorMessage = "Izin akses kamera ditolak. Silakan izinkan akses kamera.";
        } else if (err.toString().includes("NotFoundError") || err.toString().includes("OverconstrainedError")) {
          errorMessage = "Kamera tidak ditemukan.";
        } else {
          errorMessage += err.toString();
        }
        
        alert(errorMessage);
        readerDiv.style.display = "none";
        cameraActive = false;
        scannerButton.textContent = "üì∑ Aktifkan Kamera";
        cameraStatus.textContent = "Kamera tidak aktif";
        cameraStatus.className = "camera-status inactive";
      }
    }

    // =============== FUNGSI UPLOAD DATA ===============
    function saveUploadedData() {
      console.log('Save uploaded data clicked');
      if (!uploadLokasiTerkunci) {
        alert("Kunci lokasi terlebih dahulu.");
        return;
      }

      if (uploadedItems.length === 0) {
        alert("Tidak ada data untuk disimpan.");
        return;
      }

      const user = document.getElementById("uploadUserInput").value || "Unknown";
      const lokasi = document.getElementById("uploadLokasiInput").value;
      
      let count = 0;
      uploadedItems.forEach(item => {
        const index = dataScan.findIndex(scan => scan.barcode === item.barcode && scan.lokasi === lokasi && scan.user === user);
        
        if (index > -1) {
          dataScan[index].qty += item.qty;
        } else {
          dataScan.push({
            user: user,
            lokasi: lokasi,
            barcode: item.barcode,
            nama: item.nama,
            qty: item.qty
          });
        }
        count++;
      });

      saveDataToLocalStorage();
      updateTable();
      alert(`‚úÖ Berhasil menyimpan ${count} data barang.`);
      uploadedItems = [];
      updateUploadedItemsTable();
      saveDataToLocalStorage();
    }

    function clearUploadedData() {
      console.log('Clear uploaded data clicked');
      if (confirm("Yakin ingin menghapus semua data yang diupload?")) {
        uploadedItems = [];
        updateUploadedItemsTable();
        saveDataToLocalStorage();
      }
    }

    // =============== FUNGSI EKSPOR DATA ===============
    function exportData() {
      console.log('Export data clicked');
      if (dataScan.length === 0) {
        alert("Tidak ada data untuk diexport.");
        return;
      }

      try {
        const ws = XLSX.utils.json_to_sheet(dataScan);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Stok Barang");
        XLSX.writeFile(wb, "stok_barang_" + new Date().toISOString().slice(0,10) + ".xlsx");
        alert(`‚úÖ Data berhasil diexport (${dataScan.length} baris)`);
      } catch (error) {
        alert("‚ùå Gagal mengexport data: " + error.message);
        console.error("Export error:", error);
      }
    }

    // =============== FUNGSI SUPABASE ===============
    function initSupabaseClient(url, key) {
      try {
        if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
          throw new Error('URL Supabase tidak valid.');
        }
        
        if (key.length < 10) {
          throw new Error('API Key tidak valid');
        }
        
        supabaseClient = window.supabase.createClient(url, key);
        console.log("Supabase initialized successfully");
        return true;
      } catch (error) {
        console.error("Error initializing Supabase:", error);
        return false;
      }
    }

    function showSupabaseConfig() {
      console.log('Show supabase config clicked');
      document.getElementById('supabaseUrl').value = localStorage.getItem("supabaseUrl") || "";
      document.getElementById('supabaseKey').value = localStorage.getItem("supabaseKey") || "";
      document.getElementById('supabaseModal').style.display = 'block';
    }

    function saveSupabaseConfig() {
      console.log('Save supabase config clicked');
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();
      
      if (!url || !key) {
        alert("URL dan API Key Supabase harus diisi.");
        return;
      }
      
      if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
        alert("URL Supabase harus dalam format: https://your-project.supabase.co");
        return;
      }
      
      localStorage.setItem("supabaseUrl", url);
      localStorage.setItem("supabaseKey", key);
      
      if (initSupabaseClient(url, key)) {
        alert("‚úÖ Konfigurasi Supabase berhasil disimpan.");
        document.getElementById('supabaseModal').style.display = 'none';
      }
    }

    async function saveToSupabase() {
      console.log('Save to supabase clicked');
      if (!supabaseClient) {
        alert("Silakan konfigurasi Supabase terlebih dahulu.");
        showSupabaseConfig();
        return;
      }

      if (dataScan.length === 0) {
        alert("Tidak ada data untuk disimpan.");
        return;
      }

      const saveBtn = document.getElementById('saveToSupabaseBtn');
      if (!saveBtn) return;
      
      const originalText = saveBtn.textContent;
      saveBtn.innerHTML = '<div class="spinner"></div> Menyimpan...';
      saveBtn.disabled = true;

      try {
        const dataToSave = dataScan.map(item => ({
          ...item,
          created_at: new Date().toISOString()
        }));

        const { data, error } = await supabaseClient
          .from('stok_barang')
          .insert(dataToSave);

        if (error) {
          throw error;
        }

        alert(`‚úÖ Data berhasil disimpan ke Supabase! ${dataToSave.length} baris ditambahkan.`);
        
        dataScan = [];
        saveDataToLocalStorage();
        updateTable();
        
      } catch (error) {
        console.error('Error saving to Supabase:', error);
        alert("‚ùå Gagal menyimpan data ke Supabase: " + error.message);
      } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    }

    // =============== FUNGSI DOWNLOAD SUPABASE ===============
    function showDownloadModal() {
      console.log('Show download modal clicked');
      if (!supabaseClient) {
        alert("Silakan konfigurasi Supabase terlebih dahulu.");
        showSupabaseConfig();
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = today;
      document.getElementById('endDate').value = today;
      
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('downloadStatus').style.display = 'none';
      document.getElementById('downloadStatus').className = 'download-status';
      const downloadButton = document.getElementById('downloadSupabaseBtn');
      if (downloadButton) {
        downloadButton.disabled = false;
        downloadButton.textContent = 'Download';
      }
      
      loadUsersFromSupabase();
      document.getElementById('downloadModal').style.display = 'block';
    }

    function closeDownloadModal() {
      document.getElementById('downloadModal').style.display = 'none';
      isDownloading = false;
    }

    async function loadUsersFromSupabase() {
      try {
        const { data, error } = await supabaseClient
          .from('stok_barang')
          .select('user')
          .order('user', { ascending: true });
          
        if (error) throw error;
        
        const userList = document.getElementById('userList');
        if (!userList) return;
        
        userList.innerHTML = '<button class="user-button active" data-user="all">Semua User</button>';
        
        if (data && data.length > 0) {
          const uniqueUsers = [...new Set(data.map(item => item.user))].filter(user => user);
          
          uniqueUsers.forEach(user => {
            const button = document.createElement('button');
            button.className = 'user-button';
            button.textContent = user;
            button.dataset.user = user;
            userList.appendChild(button);
          });
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function downloadSupabaseData() {
      if (isDownloading) return;
      
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        alert('Pilih tanggal mulai dan tanggal selesai.');
        return;
      }
      
      isDownloading = true;
      const downloadButton = document.getElementById('downloadSupabaseBtn');
      if (!downloadButton) return;
      
      downloadButton.disabled = true;
      downloadButton.textContent = 'Downloading...';
      
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const downloadStatus = document.getElementById('downloadStatus');
      
      progressContainer.style.display = 'block';
      downloadStatus.style.display = 'none';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      
      try {
        let query = supabaseClient
          .from('stok_barang')
          .select('*')
          .gte('created_at', `${startDate}T00:00:00`)
          .lte('created_at', `${endDate}T23:59:59`);
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
          throw new Error('Tidak ada data untuk rentang tanggal ini.');
        }
        
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Stok Barang");
        XLSX.writeFile(wb, `stok_barang_${startDate}_${endDate}.xlsx`);
        
        downloadStatus.style.display = 'block';
        downloadStatus.className = 'download-status success';
        downloadStatus.textContent = `‚úÖ Berhasil mendownload ${data.length} data!`;
        
        setTimeout(() => {
          closeDownloadModal();
        }, 3000);
        
      } catch (error) {
        console.error('Error downloading data:', error);
        downloadStatus.style.display = 'block';
        downloadStatus.className = 'download-status error';
        downloadStatus.textContent = `‚ùå Gagal mendownload data: ${error.message}`;
      } finally {
        isDownloading = false;
        downloadButton.disabled = false;
        downloadButton.textContent = 'Download';
      }
    }

    // =============== FUNGSI LAINNYA ===============
    function hapusSemuaData() {
      console.log('Hapus semua data clicked');
      if (confirm("Yakin ingin menghapus SEMUA data yang telah diinput?")) {
        dataScan = [];
        saveDataToLocalStorage();
        updateTable();
        alert("Semua data telah dihapus.");
      }
    }

    // =============== FUNGSI DEBUG ===============
    function debugFunctions() {
      console.log('=== DEBUG INFO ===');
      console.log('dataScan length:', dataScan.length);
      console.log('uploadedItems length:', uploadedItems.length);
      console.log('dataBarang keys:', Object.keys(dataBarang).length);
      console.log('lokasiTerkunci:', lokasiTerkunci);
      console.log('uploadLokasiTerkunci:', uploadLokasiTerkunci);
      console.log('cameraActive:', cameraActive);
      console.log('supabaseClient initialized:', supabaseClient !== null);
      
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.innerHTML = `
          Data Scan: ${dataScan.length} items<br>
          Uploaded Items: ${uploadedItems.length} items<br>
          Camera: ${cameraActive ? 'Aktif' : 'Tidak Aktif'}<br>
          Supabase: ${supabaseClient ? 'Terhubung' : 'Tidak Terhubung'}
        `;
      }
    }

    function clearAllData() {
      if (confirm('Yakin ingin menghapus SEMUA data termasuk konfigurasi?')) {
        localStorage.clear();
        location.reload();
      }
    }

    // =============== SETUP EVENT LISTENERS ===============
    function setupEventListeners() {
      console.log('Setting up event listeners...');
      
      // Tab menu
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          openTab(tabId, this);
        });
      });
      
      // Lokasi buttons
      document.getElementById('lockLokasiBtn')?.addEventListener('click', lockLokasi);
      document.getElementById('ubahLokasiBtn')?.addEventListener('click', ubahLokasi);
      document.getElementById('lockUploadLokasiBtn')?.addEventListener('click', lockUploadLokasi);
      document.getElementById('ubahUploadLokasiBtn')?.addEventListener('click', ubahUploadLokasi);
      
      // Upload buttons
      document.getElementById('uploadFileBtn')?.addEventListener('click', handleFileUpload);
      document.getElementById('bulkUploadBtn')?.addEventListener('click', handleBulkUpload);
      document.getElementById('tambahDataBtn')?.addEventListener('click', tambahData);
      
      // Scanner button
      document.getElementById('scannerButton')?.addEventListener('click', toggleScanner);
      
      // Upload data buttons
      document.getElementById('saveUploadedDataBtn')?.addEventListener('click', saveUploadedData);
      document.getElementById('clearUploadedDataBtn')?.addEventListener('click', clearUploadedData);
      
      // Main buttons
      document.getElementById('exportDataBtn')?.addEventListener('click', exportData);
      document.getElementById('saveToSupabaseBtn')?.addEventListener('click', saveToSupabase);
      document.getElementById('showDownloadModalBtn')?.addEventListener('click', showDownloadModal);
      document.getElementById('showSupabaseConfigBtn')?.addEventListener('click', showSupabaseConfig);
      document.getElementById('hapusSemuaDataBtn')?.addEventListener('click', hapusSemuaData);
      
      // Debug buttons
      document.getElementById('debugBtn')?.addEventListener('click', debugFunctions);
      document.getElementById('clearAllDataBtn')?.addEventListener('click', clearAllData);
      
      // Modal buttons
      document.getElementById('confirmLeaveYes')?.addEventListener('click', () => confirmLeave(true));
      document.getElementById('confirmLeaveNo')?.addEventListener('click', () => confirmLeave(false));
      document.getElementById('saveSupabaseConfigBtn')?.addEventListener('click', saveSupabaseConfig);
      document.getElementById('cancelSupabaseConfigBtn')?.addEventListener('click', () => {
        document.getElementById('supabaseModal').style.display = 'none';
      });
      document.getElementById('downloadSupabaseBtn')?.addEventListener('click', downloadSupabaseData);
      document.getElementById('cancelDownloadBtn')?.addEventListener('click', closeDownloadModal);
      
      // User list selection
      document.getElementById('userList')?.addEventListener('click', function(e) {
        if (e.target.classList.contains('user-button')) {
          const buttons = this.querySelectorAll('.user-button');
          if (e.target.dataset.user === 'all') {
            buttons.forEach(btn => {
              if (btn.dataset.user === 'all') {
                btn.classList.add('active');
              } else {
                btn.classList.remove('active');
              }
            });
          } else {
            buttons.forEach(btn => {
              if (btn.dataset.user === 'all') {
                btn.classList.remove('active');
              }
            });
            e.target.classList.toggle('active');
          }
        }
      });
      
      // Barcode input
      const barcodeInput = document.getElementById("barcodeInput");
      if (barcodeInput) {
        barcodeInput.addEventListener("input", function() {
          const barcode = this.value.trim();
          const nama = dataBarang[barcode];
          document.getElementById("namaBarangInput").value = nama || "Barang tidak ditemukan";
        });
        
        barcodeInput.addEventListener("keypress", function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            tambahData();
          }
        });
      }
      
      // Qty input
      const qtyInput = document.getElementById("qtyInput");
      if (qtyInput) {
        qtyInput.addEventListener("keypress", function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            tambahData();
          }
        });
      }
      
      // Before unload event
      window.addEventListener('beforeunload', function(e) {
        if (shouldConfirmLeave) {
          e.preventDefault();
          e.returnValue = '';
          return '';
        }
      });
      
      console.log('Event listeners setup complete');
    }

    // =============== START APPLICATION ===============
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
